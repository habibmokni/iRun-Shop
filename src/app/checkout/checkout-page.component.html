<div class="checkout-page">
	<!-- Custom step indicator -->
	<nav class="step-bar">
		<button
			class="step-indicator"
			[class.active]="activeStep() === 0"
			[class.done]="activeStep() > 0"
			(click)="goToStep(0)"
		>
			<span class="step-dot">@if (activeStep() > 0) { <mat-icon>check</mat-icon> } @else { 1 }</span>
			<span class="step-label">Delivery</span>
		</button>
		<span class="step-line" [class.done]="activeStep() > 0"></span>
		<button
			class="step-indicator"
			[class.active]="activeStep() === 1"
			[class.done]="activeStep() > 1"
			(click)="goToStep(1)"
		>
			<span class="step-dot">@if (activeStep() > 1) { <mat-icon>check</mat-icon> } @else { 2 }</span>
			<span class="step-label">Billing & Payment</span>
		</button>
		<span class="step-line" [class.done]="activeStep() > 1"></span>
		<button
			class="step-indicator"
			[class.active]="activeStep() === 2"
			[disabled]="activeStep() < 2"
			(click)="goToStep(2)"
		>
			<span class="step-dot">3</span>
			<span class="step-label">Overview</span>
		</button>
	</nav>

	<div class="checkout-layout">
		<!-- ═══ Main content area ═══ -->
		<div class="checkout-main">

			<!-- ── Step 1: Delivery ── -->
			@if (activeStep() === 0) {
				<form [formGroup]="shippingMethod">
					<!-- Delivery method selection -->
					<div class="delivery-options">
						<button
							type="button"
							class="delivery-option"
							[class.active]="isClickNCollect()"
							(click)="selectDelivery('Click & Collect', 0)"
						>
							<mat-icon class="delivery-option-icon" fontSet="material-icons-outlined">shopping_bag</mat-icon>
							<span class="delivery-option-label">Click & Collect</span>
							<span class="delivery-option-desc">Pick up in store</span>
						</button>
						<button
							type="button"
							class="delivery-option"
							[class.active]="!isClickNCollect()"
							(click)="selectDelivery('Home Delivery', 1)"
						>
							<mat-icon class="delivery-option-icon" fontSet="material-icons-outlined">local_shipping</mat-icon>
							<span class="delivery-option-label">Home Delivery</span>
							<span class="delivery-option-desc">Shipped to your door</span>
						</button>
					</div>

					<!-- Delivery content -->
					@if (isClickNCollect()) {
						<div class="delivery-content">
							<app-click-collect
								[user]="user()"
								(storeChanged)="onStoreChange($event)"
								(productsToRemove)="onProductsToRemove($event)"
								(dateSelected)="onDateSelected($event)"
								(timeSelected)="onTimeSelected($event)"
								(isAllItemsAvailable)="onCncItemsAvailable($event)"
							/>
						</div>
					} @else {
						<div class="delivery-content">
							<form [formGroup]="billing">
								@if (onlineStockCheck().allAvailable) {
									<app-billing-details [billing]="billing" />
								} @else {
									<div class="unavailable-section">
										<div class="unavailable-header">
											<h2>Not all items available</h2>
											<h5>
												Some items in your cart cannot be shipped with
												this option. Please remove them or choose a
												different delivery method.
											</h5>
										</div>
										@for (
											product of onlineStockCheck().unavailableItems;
											track product.modelNo
										) {
											<mat-card class="unavailable-item">
												<div class="unavailable-img">
													<img
														[ngSrc]="product.productImage"
														alt="{{ product.productName }}"
														width="80"
														height="80"
													/>
												</div>
												<div class="unavailable-info">
													<h3>{{ product.productName }}</h3>
													<span class="field-error">Out of stock</span>
												</div>
												<div class="unavailable-price">
													<h2>{{ product.price | number: '1.2-2' }}€</h2>
												</div>
											</mat-card>
										}
										<div class="remove-actions">
									<button
										matButton="filled"
										type="button"
										(click)="removeProductsUnavailable()"
									>
												Remove unavailable items
											</button>
										</div>
									</div>
								}
							</form>
						</div>
					}

					<div class="step-actions">
						@if (isClickNCollect()) {
					<button
						matButton="filled"
						[disabled]="!cncAllItemsAvailable()"
						(click)="onCncContinue()"
					>
								Continue
							</button>
						} @else {
					<button
						matButton="filled"
						[disabled]="!onlineStockCheck().allAvailable && billing.invalid"
						(click)="onDeliveryContinue()"
					>
								Continue
							</button>
						}
					</div>
				</form>
			}

			<!-- ── Step 2: Billing & Payment ── -->
			@if (activeStep() === 1) {
				<mat-accordion>
					@if (isClickNCollect()) {
						<form [formGroup]="billing">
							<mat-expansion-panel
								[expanded]="step() === 0"
								(opened)="setStep(0)"
							>
								<mat-expansion-panel-header>
									<mat-panel-title>
										<span class="panel-header-row">
											<mat-icon class="panel-header-icon">receipt_long</mat-icon>
											Billing Details
										</span>
									</mat-panel-title>
								</mat-expansion-panel-header>
								<app-billing-details [billing]="billing" type="Billing Details" />
								<mat-action-row>
									<button matButton="filled" (click)="nextStep()">
										Continue
									</button>
								</mat-action-row>
							</mat-expansion-panel>
						</form>
					}

					<form [formGroup]="paymentMethod">
						<mat-expansion-panel
							[expanded]="isClickNCollect() ? step() === 1 : true"
							(opened)="setStep(1)"
						>
							<mat-expansion-panel-header>
								<mat-panel-title>
									<span class="panel-header-row">
										<mat-icon class="panel-header-icon">credit_card</mat-icon>
										Payment Method
									</span>
								</mat-panel-title>
							</mat-expansion-panel-header>
							<app-payment-methods [paymentMethod]="paymentMethod" />
						</mat-expansion-panel>
					</form>
				</mat-accordion>

				<div class="step-actions">
					<button matButton="outlined" (click)="goToStep(0)">
						Back
					</button>
					<button matButton="filled" (click)="onBillingContinue()">
						Continue
					</button>
				</div>
			}

			<!-- ── Step 3: Order Overview ── -->
			@if (activeStep() === 2) {
				@if (order(); as currentOrder) {
					<!-- Order items -->
					<div class="overview-section">
						<h3 class="section-title">
							<mat-icon class="section-icon">inventory_2</mat-icon>
							Your Items
						</h3>
						<div class="order-items">
							@for (product of cartProducts(); track product.modelNo) {
								<div class="order-item">
									<div class="order-item-img">
										<img
											[ngSrc]="product.productImage"
											alt="{{ product.productName }}"
											width="72"
											height="72"
										/>
									</div>
									<div class="order-item-info">
										<span class="order-item-name">{{ product.productName }}</span>
										<span class="order-item-meta">
											Size {{ product.size }} &middot; Qty {{ product.noOfItems }}
										</span>
									</div>
									<span class="order-item-price">
										{{ product.price * product.noOfItems | number: '1.2-2' }}€
									</span>
								</div>
							}
						</div>
					</div>

					<!-- Delivery info -->
					<div class="overview-section">
						<h3 class="section-title">
							<mat-icon class="section-icon">local_shipping</mat-icon>
							Delivery
						</h3>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">Method</span>
								<span class="info-value">{{ currentOrder.pickupType }}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Address</span>
								<span class="info-value">{{ currentOrder.storeLocation.address }}</span>
							</div>
							@if (currentOrder.pickupDate) {
								<div class="info-item">
									<span class="info-label">Pickup</span>
									<span class="info-value">
										{{ currentOrder.pickupDate | date: 'mediumDate' }}
										at {{ currentOrder.pickupTime }}
									</span>
								</div>
							}
						</div>
					</div>

					<!-- Billing info -->
					<div class="overview-section">
						<h3 class="section-title">
							<mat-icon class="section-icon">receipt_long</mat-icon>
							Billing
						</h3>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">Name</span>
								<span class="info-value">{{ currentOrder.billingDetails.name }}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Email</span>
								<span class="info-value">{{ currentOrder.billingDetails.email }}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Phone</span>
								<span class="info-value">{{ currentOrder.billingDetails.phoneNo }}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Address</span>
								<span class="info-value">{{ currentOrder.billingDetails.address1 }}</span>
							</div>
						</div>
					</div>

					<!-- Payment info -->
					<div class="overview-section">
						<h3 class="section-title">
							<mat-icon class="section-icon">credit_card</mat-icon>
							Payment
						</h3>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">Method</span>
								<span class="info-value">{{ currentOrder.paymentOption }}</span>
							</div>
						</div>
						<p class="redirect-note">
							You will be redirected to {{ currentOrder.paymentOption }}
							to confirm your purchase.
						</p>
					</div>

					<!-- Totals -->
					<div class="overview-totals">
						<div class="totals-row">
							<span>Subtotal</span>
							<span>{{ orderPrice() | number: '1.2-2' }}€</span>
						</div>
						<div class="totals-row">
							<span>Shipping</span>
							<span class="free-tag">Free</span>
						</div>
						<div class="totals-row">
							<span>Payment fee</span>
							<span class="free-tag">Free</span>
						</div>
						<div class="totals-divider"></div>
						<div class="totals-row totals-total">
							<span>Total</span>
							<span>{{ orderPrice() | number: '1.2-2' }}€</span>
						</div>
					</div>

					<!-- Order ID -->
					<div class="order-id-bar">
						<mat-icon>tag</mat-icon>
						Order ID: <strong>{{ currentOrder.orderId }}</strong>
					</div>

					<!-- Actions -->
					<div class="overview-actions">
					<button
						class="confirm-btn"
						matButton="filled"
						(click)="onOrderConfirmation()"
					>
							Confirm Order
						</button>
						<button class="back-btn" matButton="outlined" (click)="goToStep(1)">
							Back
						</button>
					</div>
				}
			}
		</div>

		<!-- ═══ Sidebar: order summary (desktop) ═══ -->
		<aside class="sidebar">
			<h3 class="sidebar-title">Your Order</h3>
			<div class="sidebar-items">
				@for (product of cartProducts(); track product.modelNo) {
					<div class="sidebar-item">
						<div class="sidebar-item-img">
							<img
								[ngSrc]="product.productImage"
								alt="{{ product.productName }}"
								width="56"
								height="56"
							/>
						</div>
						<div class="sidebar-item-info">
							<span class="sidebar-item-name">{{ product.productName }}</span>
							<span class="sidebar-item-meta">
								Size {{ product.size }} &middot; Qty {{ product.noOfItems }}
							</span>
						</div>
						<span class="sidebar-item-price">
							{{ product.price * product.noOfItems | number: '1.2-2' }}€
						</span>
					</div>
				}
			</div>
			<div class="sidebar-divider"></div>
			<div class="sidebar-total">
				<span>Total</span>
				<span>{{ orderPrice() | number: '1.2-2' }}€</span>
			</div>

			<!-- Sidebar CTA -->
			<div class="sidebar-cta">
				@if (activeStep() === 0) {
					@if (isClickNCollect()) {
						<button matButton="filled" class="sidebar-cta-btn" [disabled]="!cncAllItemsAvailable()" (click)="onCncContinue()">Continue</button>
					} @else {
						<button matButton="filled" class="sidebar-cta-btn" [disabled]="!onlineStockCheck().allAvailable && billing.invalid" (click)="onDeliveryContinue()">Continue</button>
					}
				} @else if (activeStep() === 1) {
					<button matButton="filled" class="sidebar-cta-btn" (click)="onBillingContinue()">Continue</button>
				} @else {
					<button matButton="filled" class="sidebar-cta-btn" (click)="onOrderConfirmation()">Confirm Order</button>
				}
				@if (activeStep() > 0) {
					<button matButton="outlined" class="sidebar-back-btn" (click)="goToStep(activeStep() - 1)">Back</button>
				}
			</div>
		</aside>
	</div>

	<!-- Mobile sticky CTA -->
	<div class="mobile-cta">
		@if (activeStep() === 0) {
			@if (isClickNCollect()) {
				<button class="mobile-cta-btn" matButton="filled" [disabled]="!cncAllItemsAvailable()" (click)="onCncContinue()">
					<span class="mobile-cta-text">Continue</span>
					<span class="mobile-cta-divider"></span>
					<span class="mobile-cta-price">{{ orderPrice() | number: '1.2-2' }}€</span>
				</button>
			} @else {
				<button class="mobile-cta-btn" matButton="filled" [disabled]="!onlineStockCheck().allAvailable && billing.invalid" (click)="onDeliveryContinue()">
					<span class="mobile-cta-text">Continue</span>
					<span class="mobile-cta-divider"></span>
					<span class="mobile-cta-price">{{ orderPrice() | number: '1.2-2' }}€</span>
				</button>
			}
		} @else if (activeStep() === 1) {
			<button class="mobile-cta-btn" matButton="filled" (click)="onBillingContinue()">
				<span class="mobile-cta-text">Continue</span>
				<span class="mobile-cta-divider"></span>
				<span class="mobile-cta-price">{{ orderPrice() | number: '1.2-2' }}€</span>
			</button>
		} @else {
			<button class="mobile-cta-btn" matButton="filled" (click)="onOrderConfirmation()">
				<span class="mobile-cta-text">Confirm Order</span>
				<span class="mobile-cta-divider"></span>
				<span class="mobile-cta-price">{{ orderPrice() | number: '1.2-2' }}€</span>
			</button>
		}
	</div>
</div>

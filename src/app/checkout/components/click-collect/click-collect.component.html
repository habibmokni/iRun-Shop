<div class="cnc-section">
	<!-- Step 1: Select Store -->
	<div class="cnc-step">
		<div class="step-header">
			<span class="step-number">1</span>
			<h3 class="step-title">Choose your pickup store</h3>
		</div>

		@if (selectedStore(); as myStore) {
			<!-- Current selected store shown prominently -->
			<div class="current-store-section">
				<span class="store-section-label">Your Store</span>
				<app-store-card
					[store]="myStore"
					[selected]="true"
					[distance]="distanceMap()[myStore.id]"
					[stock]="stockMap()[myStore.id]"
					(storeSelect)="onSelectStore($event)"
				/>
			</div>

			<!-- Toggle to show other stores -->
			<button class="change-store-toggle" (click)="otherStoresExpanded.set(!otherStoresExpanded())">
				<span>{{ otherStoresExpanded() ? 'Hide other stores' : 'Change store' }}</span>
				<mat-icon>{{ otherStoresExpanded() ? 'expand_less' : 'expand_more' }}</mat-icon>
			</button>

			@if (otherStoresExpanded()) {
				<div class="store-list">
					@for (store of otherStores(); track store.id) {
						<app-store-card
							[store]="store"
							[selected]="false"
							[distance]="distanceMap()[store.id]"
							[stock]="stockMap()[store.id]"
							(storeSelect)="onSelectStore($event)"
						/>
					}
				</div>
			}
		} @else {
			<!-- No store selected yet: show full list -->
			<div class="store-list">
				@for (store of stores(); track store.id) {
					<app-store-card
						[store]="store"
						[selected]="false"
						[distance]="distanceMap()[store.id]"
						[stock]="stockMap()[store.id]"
						(storeSelect)="onSelectStore($event)"
					/>
				} @empty {
					<p class="empty-msg">No stores available in your area.</p>
				}
			</div>
		}
	</div>

	<!-- Unavailable items warning -->
	@if (selectedStore() && !allAvailable()) {
		<div class="unavailable-banner">
			<div class="unavailable-header-row">
				<mat-icon class="warning-icon">warning</mat-icon>
				<div class="unavailable-text">
					<strong>{{ unavailableProducts().length }} {{ unavailableProducts().length === 1 ? 'item' : 'items' }} unavailable at this store</strong>
					<span>Remove {{ unavailableProducts().length === 1 ? 'it' : 'them' }} or try a different store.</span>
				</div>
			</div>
			<div class="unavailable-items-list">
				@for (product of unavailableProducts(); track product.modelNo) {
					<div class="unavailable-item-row">
						<img
							[src]="product.productImage"
							[alt]="product.productName"
							class="unavailable-item-img"
						/>
						<div class="unavailable-item-info">
							<span class="unavailable-item-name">{{ product.productName }}</span>
							<span class="unavailable-item-meta">Size {{ product.size }}</span>
						</div>
					</div>
				}
			</div>
	<button
			matButton="filled"
			type="button"
			(click)="removeUnavailable()"
		>
				Remove unavailable
			</button>
		</div>
	}

	<!-- Step 2: Pick a Date & Time -->
	@if (selectedStore() && allAvailable()) {
		<div class="cnc-step">
			<div class="step-header">
				<span class="step-number">2</span>
				<h3 class="step-title">Schedule your pickup</h3>
			</div>

			<div class="datetime-row">
				<mat-form-field appearance="outline" subscriptSizing="dynamic" class="date-field">
					<mat-label>Pickup date</mat-label>
					<input
						matInput
						[matDatepicker]="picker"
						[matDatepickerFilter]="weekdayFilter"
						[min]="minDate"
						[max]="maxDate"
						(dateChange)="onDateChange($event.value)"
						readonly
					/>
					<mat-datepicker-toggle matIconSuffix [for]="picker" />
					<mat-datepicker #picker />
				</mat-form-field>

				<mat-form-field appearance="outline" subscriptSizing="dynamic" class="time-field">
					<mat-label>Pickup time</mat-label>
					<input
						matInput
						[matTimepicker]="timePicker"
						[matTimepickerMin]="minTime()"
						[matTimepickerMax]="maxTime()"
						(valueChange)="onTimeChange($event)"
						readonly
					/>
					<mat-timepicker-toggle matIconSuffix [for]="timePicker" />
					<mat-timepicker #timePicker [interval]="'30m'" />
				</mat-form-field>
			</div>
		</div>
	}

	<!-- Summary -->
	@if (isComplete()) {
		<div class="cnc-summary">
			<mat-icon class="check-icon">check_circle</mat-icon>
			<div class="summary-text">
				<strong>{{ selectedStore()?.name }}</strong>
				<span>{{ selectedDate() | date: 'mediumDate' }} at {{ selectedTime() }}</span>
			</div>
		</div>
	}
</div>

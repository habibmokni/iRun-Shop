<!-- Drag handle -->
<div class="drag-handle"></div>

<!-- Header -->
<div class="sheet-header">
	<div class="sheet-title">
		<h2>Check Store Availability</h2>
		<p class="sheet-subtitle">Find this product near you</p>
	</div>
	<button mat-icon-button class="close-btn" (click)="close()">
		<mat-icon>close</mat-icon>
	</button>
</div>

<!-- Size selector (if no size chosen yet) -->
@if (!isSizeSelected()) {
	<div class="sheet-section">
		<span class="section-label">Select a size first</span>
		<div class="size-chips">
			@for (size of data.sizes; track size) {
				<button
					matButton="outlined"
					class="size-chip"
					(click)="changeSize(size)"
				>
					{{ size }}
				</button>
			}
		</div>
	</div>
} @else {
	<!-- Selected size pill -->
	<div class="sheet-section">
		<button matButton="outlined" class="selected-size-pill" (click)="resetSize()">
			<mat-icon>straighten</mat-icon>
			Size {{ selectedSize() }}
			<mat-icon class="change-icon">edit</mat-icon>
		</button>
	</div>
}

<!-- Main content (hidden, not removed, so autocomplete stays in DOM) -->
<div class="sheet-body" [class.hidden]="!isSizeSelected()">
	<mat-tab-group mat-align-tabs="start">
		<mat-tab label="Address">
			<div class="search-row">
				<mat-form-field appearance="outline" class="search-field">
					<mat-icon matPrefix>search</mat-icon>
					<input id="search" matInput placeholder="Enter zip code or address" />
				</mat-form-field>
				<button mat-icon-button class="location-btn" (click)="currentLocation()">
					<mat-icon>my_location</mat-icon>
				</button>
			</div>

			@if (nearByStores().length > 0) {
				<div class="stores-list">
					@for (entry of nearByStores(); track entry.store.id) {
						<mat-card appearance="outlined" class="store-card">
							<mat-card-content>
								<div class="store-header">
									<h3 class="store-name">{{ entry.store.name }}</h3>
									<span class="distance">
										<mat-icon>room</mat-icon>
										{{ entry.distance.toFixed(1) }}km
									</span>
								</div>
								<p class="store-address">{{ entry.store.address }}</p>
								<span
									class="stock-badge"
									[class.good]="entry.stock > 5"
									[class.low]="entry.stock > 0 && entry.stock <= 5"
									[class.out]="entry.stock === 0"
								>
									@if (entry.stock > 5) {
										In stock
									} @else if (entry.stock > 0) {
										Low stock
									} @else {
										Out of stock
									}
								</span>
							</mat-card-content>
							<mat-card-actions>
								<button matButton="filled" (click)="onStoreSelect(entry.store)">
									Select Store
								</button>
							</mat-card-actions>
						</mat-card>
					}
				</div>
			} @else {
				<div class="empty-state">
					<mat-icon class="empty-icon">store</mat-icon>
					<p>Search an address or use your location to find nearby stores</p>
				</div>
			}
		</mat-tab>

		<mat-tab label="Map">
			@if (isSizeSelected()) {
				<div class="map-container">
					<app-maps
						[mapHeight]="mapDimensions().height"
						[mapWidth]="mapDimensions().width"
						[ModelNo]="data.modelNo"
						[size]="selectedSize()!"
					/>
				</div>
			}
		</mat-tab>
	</mat-tab-group>
</div>

<div class="store-selector-page container-narrow">
	<h1 class="page-title">Find a Store</h1>
	<p class="page-subtitle">
		Select your preferred store for Click & Collect and stock availability.
	</p>

	<!-- Tab navigation -->
	<nav class="view-tabs">
		<button
			class="view-tab"
			[class.active]="activeView() === 'list'"
			(click)="activeView.set('list')"
		>
			<mat-icon>list</mat-icon>
			List View
		</button>
		<button
			class="view-tab"
			[class.active]="activeView() === 'map'"
			(click)="activeView.set('map')"
		>
			<mat-icon>map</mat-icon>
			Map View
		</button>
	</nav>

	<!-- ── Map View (cnc-store-selector) ── -->
	@if (activeView() === 'map') {
		@if (mapsAvailable()) {
			<div class="map-container">
				<cnc-store-selector />
			</div>
		} @else {
			<div class="maps-unavailable">
				<mat-icon class="unavailable-icon">map</mat-icon>
				<h3>Maps is not available right now</h3>
				<p>Google Maps could not be loaded. Please try again later or use the List View.</p>
				<button matButton="filled" (click)="activeView.set('list')">
					Switch to List View
				</button>
			</div>
		}
	}

	<!-- ── List View ── -->
	@if (activeView() === 'list') {
		<!-- Current store (shown when one is already selected) -->
		@if (currentStore(); as myStore) {
			<div class="current-store-section">
				<h2 class="section-label">Your Store</h2>
				<app-store-card
					[store]="myStore"
					[selected]="true"
					[distance]="distanceMap()[myStore.id]"
					(storeSelect)="selectStore($event)"
				/>
			</div>

			<!-- Toggle to show other stores -->
			<button class="change-store-toggle" (click)="otherStoresExpanded.set(!otherStoresExpanded())">
				<span>{{ otherStoresExpanded() ? 'Hide other stores' : 'Change store' }}</span>
				<mat-icon>{{ otherStoresExpanded() ? 'expand_less' : 'expand_more' }}</mat-icon>
			</button>
		}

		<!-- Other stores (always shown if no current store, toggled if there is one) -->
		@if (!currentStore() || otherStoresExpanded()) {
			<!-- Search -->
			<div class="search-bar">
				<mat-icon class="search-icon">search</mat-icon>
				<input
					type="text"
					class="search-input"
					placeholder="Search by name or address..."
					[value]="searchQuery()"
					(input)="onSearch($event)"
				/>
				@if (searchQuery()) {
					<button class="search-clear" (click)="searchQuery.set('')">
						<mat-icon>close</mat-icon>
					</button>
				}
			</div>

			@if (filteredStores().length) {
				@if (currentStore()) {
					<h2 class="section-label">Other Stores</h2>
				}
				<div class="store-grid">
					@for (store of filteredStores(); track store.id) {
						<app-store-card
							[store]="store"
							[selected]="selectedStoreId() === store.id"
							[distance]="distanceMap()[store.id]"
							(storeSelect)="selectStore($event)"
						/>
					}
				</div>
			} @else if (stores().length) {
				<div class="empty-state">
					<mat-icon class="empty-icon">search_off</mat-icon>
					<p>No stores match "{{ searchQuery() }}"</p>
				</div>
			} @else {
				<div class="empty-state">
					<mat-icon class="empty-icon">store</mat-icon>
					<p>No stores available</p>
				</div>
			}
		}
	}
</div>
